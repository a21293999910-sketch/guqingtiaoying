<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>古琴调音器</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui, sans-serif;-webkit-tap-highlight-color:transparent}
body{background:#000;color:#fff;min-height:100vh;display:flex;justify-content:center;padding:12px;touch-action:manipulation}
.container{width:100%;max-width:380px;background:#111;border-radius:16px;padding:20px 16px;border:1px solid #222}
.title{text-align:center;font-size:20px;margin-bottom:24px}

.pitch-box{text-align:center;margin-bottom:20px}
.note{font-size:46px;font-weight:700;height:50px}
.freq{font-size:16px;color:#aaa;margin-top:4px}

.meter{height:26px;background:#1a1a1a;border-radius:13px;border:1px solid #333;position:relative;overflow:hidden;margin:16px 0}
.meter .center{position:absolute;left:50%;top:0;height:100%;width:2px;background:#0f0;transform:translateX(-50%)}
.meter .pointer{position:absolute;left:50%;top:0;height:100%;width:3px;background:#fff;transform:translateX(-50%);transition:left 0.2s ease-out}

.tip{text-align:center;font-size:15px;margin-bottom:20px;min-height:18px}
.tip.error{color:#ff4444}
.tip.success{color:#00cc00}

.sensitivity{margin:16px 0}
.sensi-label{display:flex;justify-content:space-between;font-size:13px;color:#999;margin-bottom:6px}
input[type="range"]{width:100%;height:6px;appearance:none;background:#222;border-radius:3px;outline:none}
input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;background:#fff;border-radius:50%}

.base-switch{display:flex;gap:10px;justify-content:center;margin:14px 0}
.base-btn{padding:8px 14px;border-radius:10px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:14px}
.base-btn.active{background:#fff;color:#000}

.strings{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:16px 0}
.string{padding:6px 10px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;font-size:13px}
.string.active{background:#fff;color:#000}

.btns{display:flex;gap:16px;justify-content:center;margin-top:20px}
.btn{padding:12px 24px;border-radius:50px;border:none;font-weight:600;font-size:15px;cursor:pointer;
  -webkit-user-select:none;user-select:none;touch-action:manipulation}
.btn-green{background:#16a34a;color:#fff}
.btn-red{background:#dc2626;color:#fff}
.btn-reset{background:#333;color:#fff;padding:8px 16px;font-size:12px;margin:auto;display:block;margin-top:10px}
.btn:disabled{opacity:0.4;cursor:not-allowed}

.permission-help{text-align:center;font-size:11px;color:#888;margin-top:8px;line-height:1.4}
.hint{text-align:center;font-size:12px;color:#666;margin-top:12px}
</style>
</head>

<body>
<div class="container">
  <div class="title">古琴调音器</div>

  <div class="pitch-box">
    <div class="note">--</div>
    <div class="freq">0.00 Hz</div>
  </div>

  <div class="meter">
    <div class="center"></div>
    <div class="pointer"></div>
  </div>
  <div class="tip" id="statusTip">点击开始并允许麦克风</div>

  <div class="sensitivity">
    <div class="sensi-label">
      <span>响应速度</span>
      <span class="sensi-val">慢</span>
    </div>
    <input type="range" min="1" max="3" value="1" class="sensi-slider" id="responseSlider">
  </div>

  <div class="base-switch">
    <button class="base-btn active" data-base="440">440 Hz</button>
    <button class="base-btn" data-base="432">432 Hz</button>
  </div>

  <div class="strings">
    <button class="string active" data-note="C4" data-freq="261.63">1弦</button>
    <button class="string" data-note="D4" data-freq="293.66">2弦</button>
    <button class="string" data-note="F4" data-freq="349.23">3弦</button>
    <button class="string" data-note="G4" data-freq="392.00">4弦</button>
    <button class="string" data-note="A4" data-freq="440.00">5弦</button>
    <button class="string" data-note="c5" data-freq="523.25">6弦</button>
    <button class="string" data-note="d5" data-freq="587.33">7弦</button>
  </div>

  <div class="btns">
    <button class="btn btn-green" id="start">开始调音</button>
    <button class="btn btn-red" id="stop" disabled>停止</button>
  </div>
  
  <!-- 新增：权限重置按钮 -->
  <button class="btn-reset" id="resetPermission">重置麦克风权限</button>
  
  <div class="permission-help">
    如无法使用：设置 > 隐私 > 麦克风 > 允许此网站访问
  </div>
  
  <div class="hint">指针稳定在中间即音准</div>
</div>

<script>
// 全局兼容性处理
window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
navigator.mediaDevices = navigator.mediaDevices || {};

// DOM元素
const noteEl = document.querySelector('.note');
const freqEl = document.querySelector('.freq');
const pointerEl = document.querySelector('.pointer');
const statusTip = document.getElementById('statusTip');
const responseSlider = document.getElementById('responseSlider');
const sensiVal = document.querySelector('.sensi-val');
const baseBtns = document.querySelectorAll('.base-btn');
const stringBtns = document.querySelectorAll('.string');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const resetPermissionBtn = document.getElementById('resetPermission');

// 核心配置
let baseHz = 440;
let targetNote = 'C4';
let targetFreq = 261.63;
let responseLevel = 1;
let audioContext = null;
let analyser = null;
let mic = null;
let stream = null;
let listening = false;
let processInterval = null;

// 防抖配置
const RESPONSE_SETTINGS = {
  1: { history: 20, threshold: 1.5, smooth: 0.1, deadzone: 0.015 },
  2: { history: 12, threshold: 1.0, smooth: 0.2, deadzone: 0.010 },
  3: { history: 6, threshold: 0.5, smooth: 0.3, deadzone: 0.005 }
};

// 频率缓存
let freqBuffer = [];
let currentSmoothPos = 50;
let lastValidFreq = 0;

// 古琴音高
const GUQIN_NOTES = {
  'C4': 261.63,
  'D4': 293.66,
  'F4': 349.23,
  'G4': 392.00,
  'A4': 440.00,
  'c5': 523.25,
  'd5': 587.33
};

// ========== 核心修复：权限检测和处理 ==========

// 检查权限状态
async function checkPermissionStatus() {
  try {
    // 检查浏览器是否支持权限API
    if (navigator.permissions && navigator.permissions.query) {
      const status = await navigator.permissions.query({ name: 'microphone' });
      updateTip(`当前权限状态：${status.state}`, status.state === 'granted' ? 'success' : 'error');
      return status.state;
    } else {
      updateTip('无法检测权限状态，请直接尝试使用', '');
      return 'unknown';
    }
  } catch (error) {
    updateTip(`权限检测失败：${error.message}`, 'error');
    return 'error';
  }
}

// 重置权限（核心修复）
resetPermissionBtn.addEventListener('click', async function() {
  try {
    // 停止任何正在运行的音频
    if (listening) {
      stopAudio();
    }
    
    // 清理所有音频对象
    audioContext = null;
    analyser = null;
    mic = null;
    stream = null;
    
    // 清除权限缓存的关键：重新加载页面（移动端最有效）
    updateTip('正在重置权限设置...', '');
    
    // 对于iOS Safari，需要特殊处理
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      // iOS Safari的权限缓存需要页面刷新
      setTimeout(() => {
        window.location.reload(true);
      }, 1000);
    } else {
      // 其他浏览器尝试清除状态后重新检测
      const status = await checkPermissionStatus();
      updateTip(`权限重置完成，当前状态：${status}`, status === 'granted' ? 'success' : '');
    }
  } catch (error) {
    updateTip(`重置失败：${error.message}`, 'error');
  }
});

// 更新提示文本
function updateTip(text, type = '') {
  statusTip.textContent = text;
  statusTip.className = 'tip';
  if (type) {
    statusTip.classList.add(type);
  }
}

// ========== 修复后的开始按钮逻辑 ==========
startBtn.addEventListener('click', async function(e) {
  e.preventDefault();
  e.stopPropagation();
  
  // 立即反馈
  updateTip('正在初始化音频系统...', '');
  
  try {
    // 1. 基础检查
    if (!window.AudioContext) {
      throw new Error('您的浏览器不支持音频功能，请升级到最新版本');
    }
    
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('麦克风访问不受支持，请使用Chrome/Safari/Edge浏览器');
    }
    
    // 2. 强制创建新的音频上下文（解决缓存问题）
    if (audioContext) {
      try { audioContext.close(); } catch (e) {}
    }
    audioContext = new window.AudioContext({ latencyHint: 'interactive' });
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 8192;
    analyser.smoothingTimeConstant = 0.9;
    
    // 3. 恢复音频上下文
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
    
    // 4. 关键修复：使用不同的约束参数，避免缓存
    const constraints = {
      audio: {
        echoCancellation: false, // 关闭回声消除，避免权限冲突
        noiseSuppression: false,
        autoGainControl: false,
        channelCount: 1
      },
      video: false
    };
    
    // 5. 尝试获取麦克风（多次尝试机制）
    let attempt = 1;
    let success = false;
    
    while (attempt <= 3 && !success) {
      try {
        updateTip(`正在请求麦克风权限 (尝试 ${attempt}/3)...`, '');
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        success = true;
      } catch (err) {
        attempt++;
        if (attempt <= 3) {
          updateTip(`尝试失败，重试中 (${attempt}/3)...`, 'error');
          // 等待片刻再重试
          await new Promise(resolve => setTimeout(resolve, 500));
        } else {
          throw err;
        }
      }
    }
    
    // 6. 权限请求成功
    mic = audioContext.createMediaStreamSource(stream);
    mic.connect(analyser);
    
    // 更新状态
    listening = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    updateTip('✓ 麦克风已连接，请拨动琴弦', 'success');
    
    // 重置缓存
    freqBuffer = [];
    lastValidFreq = 0;
    currentSmoothPos = 50;
    
    // 启动处理
    clearInterval(processInterval);
    processInterval = setInterval(processAudio, 100);
    
  } catch (error) {
    console.error('麦克风错误:', error);
    
    // 详细的错误处理（核心修复）
    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
      updateTip(
        '❌ 麦克风权限被拒绝\n请在浏览器设置中开启：设置 > 网站设置 > 麦克风 > 允许', 
        'error'
      );
    } else if (error.name === 'NotFoundError') {
      updateTip('❌ 未检测到麦克风设备，请检查硬件连接', 'error');
    } else if (error.name === 'NotReadableError') {
      updateTip('❌ 麦克风被其他应用占用，请关闭后重试', 'error');
    } else if (error.name === 'AbortError') {
      updateTip('❌ 麦克风请求被取消', 'error');
    } else if (error.message.includes('secure context')) {
      updateTip('❌ 请使用HTTPS或本地文件访问', 'error');
    } else {
      updateTip(`❌ 错误：${error.message}`, 'error');
    }
    
    // 重置状态
    startBtn.disabled = false;
    stopBtn.disabled = true;
    
    // 清理资源
    cleanupAudioResources();
  }
});

// 停止音频
function stopAudio() {
  listening = false;
  clearInterval(processInterval);
  
  // 彻底关闭流（核心修复）
  if (stream) {
    stream.getTracks().forEach(track => {
      track.stop();
      track.enabled = false;
    });
    stream = null;
  }
  
  // 断开连接
  if (mic) {
    mic.disconnect();
    mic = null;
  }
  
  // 暂停音频上下文
  if (audioContext) {
    audioContext.suspend();
  }
  
  // 重置UI
  startBtn.disabled = false;
  stopBtn.disabled = true;
  noteEl.textContent = '--';
  freqEl.textContent = '0.00 Hz';
  pointerEl.style.left = '50%';
  updateTip('已停止，点击开始重新调音', '');
  
  // 重置缓存
  freqBuffer = [];
  lastValidFreq = 0;
}

// 清理音频资源
function cleanupAudioResources() {
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());
    if (mic) mic.disconnect();
    if (audioContext) audioContext.close();
  } catch (e) {
    console.log('清理资源时的轻微错误:', e);
  }
  
  audioContext = null;
  analyser = null;
  mic = null;
  stream = null;
}

// 停止按钮
stopBtn.addEventListener('click', function() {
  stopAudio();
});

// ========== 其他功能逻辑 ==========

// 更新响应速度显示
function updateResponseText() {
  const texts = ['慢', '中', '快'];
  sensiVal.textContent = texts[responseLevel - 1];
}

// 基准音切换
baseBtns.forEach(b => {
  b.addEventListener('click', () => {
    baseBtns.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    baseHz = Number(b.dataset.base);
    updateTargetFrequency();
  });
});

// 琴弦切换
stringBtns.forEach(b => {
  b.addEventListener('click', () => {
    stringBtns.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    targetNote = b.dataset.note;
    updateTargetFrequency();
    freqBuffer = [];
    lastValidFreq = 0;
    currentSmoothPos = 50;
  });
});

// 更新目标频率
function updateTargetFrequency() {
  const base440Freq = GUQIN_NOTES[targetNote];
  targetFreq = base440Freq * (baseHz / 440);
}

// 响应速度切换
responseSlider.addEventListener('input', () => {
  responseLevel = Number(responseSlider.value);
  updateResponseText();
});

// 音频处理
function processAudio() {
  if (!listening || !analyser) return;
  
  try {
    const freqData = new Float32Array(analyser.frequencyBinCount);
    analyser.getFloatFrequencyData(freqData);
    
    const detectedFreq = getFundamentalFrequency(freqData, audioContext.sampleRate);
    
    if (detectedFreq < 50 || detectedFreq > 1000) {
      return;
    }
    
    const settings = RESPONSE_SETTINGS[responseLevel];
    
    freqBuffer.push(detectedFreq);
    if (freqBuffer.length > settings.history) {
      freqBuffer.shift();
    }
    
    const sortedFreqs = [...freqBuffer].sort((a, b) => a - b);
    const medianFreq = sortedFreqs[Math.floor(sortedFreqs.length / 2)];
    
    if (lastValidFreq > 0 && Math.abs(medianFreq - lastValidFreq) < settings.threshold) {
      return;
    }
    lastValidFreq = medianFreq;
    
    const freqRatio = medianFreq / targetFreq;
    
    if (Math.abs(freqRatio - 1) < settings.deadzone) {
      updateDisplay(medianFreq, true);
      return;
    }
    
    let targetPos = 50;
    if (freqRatio > 0.8 && freqRatio < 1.2) {
      targetPos = 50 + (freqRatio - 1) * 100;
    } else if (freqRatio <= 0.8) {
      targetPos = 30;
    } else if (freqRatio >= 1.2) {
      targetPos = 70;
    }
    
    currentSmoothPos = currentSmoothPos + (targetPos - currentSmoothPos) * settings.smooth;
    currentSmoothPos = Math.max(30, Math.min(70, currentSmoothPos));
    
    pointerEl.style.left = `${currentSmoothPos}%`;
    updateDisplay(medianFreq, false);
    
  } catch (error) {
    console.error('音频处理错误:', error);
  }
}

// 基频检测
function getFundamentalFrequency(freqData, sampleRate) {
  const binCount = freqData.length;
  const nyquist = sampleRate / 2;
  const binWidth = nyquist / binCount;
  
  let maxAmplitude = -Infinity;
  let dominantBin = 0;
  
  for (let i = 1; i < binCount; i++) {
    if (freqData[i] > maxAmplitude) {
      maxAmplitude = freqData[i];
      dominantBin = i;
    }
  }
  
  let preciseFreq = dominantBin * binWidth;
  if (dominantBin > 0 && dominantBin < binCount - 1) {
    const y1 = freqData[dominantBin - 1];
    const y2 = freqData[dominantBin];
    const y3 = freqData[dominantBin + 1];
    
    const p = (y3 - y1) / (2 * (2 * y2 - y1 - y3));
    preciseFreq = (dominantBin + p) * binWidth;
  }
  
  return preciseFreq;
}

// 更新显示
function updateDisplay(freq, isAccurate) {
  freqEl.textContent = freq.toFixed(1) + ' Hz';
  
  const note = getNoteName(freq);
  noteEl.textContent = note;
  
  if (isAccurate) {
    updateTip('✓ 音准', 'success');
    pointerEl.style.left = '50%';
    currentSmoothPos = 50;
  } else {
    const ratio = freq / targetFreq;
    if (ratio < 1) {
      updateTip(`↓ 偏低 ${((1 - ratio) * 100).toFixed(1)}%`, '');
    } else {
      updateTip(`↑ 偏高 ${((ratio - 1) * 100).toFixed(1)}%`, '');
    }
  }
}

// 获取音符名称
function getNoteName(freq) {
  if (freq < 50) return '--';
  
  const midiNote = 12 * Math.log2(freq / 440) + 69;
  const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  
  const octave = Math.floor(midiNote / 12) - 1;
  const noteIndex = Math.round(midiNote) % 12;
  
  return noteNames[noteIndex] + octave;
}

// 页面加载时检查权限
window.addEventListener('load', function() {
  updateResponseText();
  // 延迟检查权限，避免干扰页面加载
  setTimeout(checkPermissionStatus, 1000);
});

// 页面隐藏/显示处理
document.addEventListener('visibilitychange', () => {
  if (listening && audioContext) {
    if (document.hidden) {
      audioContext.suspend();
    } else {
      audioContext.resume();
    }
  }
});

// 移动端触摸优化
document.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    this.click();
  });
  
  btn.addEventListener('dblclick', function(e) {
    e.preventDefault();
  });
});
</script>
</body>
</html>