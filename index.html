<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¤ç´è°ƒéŸ³å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a1a1a;
            color: white;
            font-family: system-ui, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .mode {
            color: #aaa;
            margin-bottom: 20px;
        }
        .meter {
            width: 260px;
            height: 260px;
            margin: 20px auto;
            position: relative;
        }
        .circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 16px solid #333;
        }
        .progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 16px solid #333;
            border-top-color: #4CAF50;
            transform: rotate(-90deg);
            transition: 0.1s;
        }
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .note {
            font-size: 36px;
            font-weight: bold;
        }
        .hz {
            font-size: 18px;
            color: #ccc;
            margin: 4px 0;
        }
        .status {
            font-size: 16px;
            margin-top: 4px;
        }

        /* å¼¦æŒ‰é’® */
        .strings {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        .string-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 18px;
            background: #333;
            color: white;
        }
        .string-btn.active {
            background: white;
            color: black;
        }

        /* éº¦å…‹é£æŒ‰é’® */
        .mic-btn {
            padding: 14px 26px;
            font-size: 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .mic-btn:disabled {
            background: #666;
        }

        /* åŠŸèƒ½æŒ‰é’®ç»„ */
        .bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .bar button {
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background: #333;
            color: white;
            font-size: 15px;
        }
        .bar button.active {
            background: #666;
        }

        /* çµæ•åº¦ */
        .sensitivity {
            margin: 20px 0;
            padding: 0 10px;
        }
        .sensitivity-label {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .sensitivity-slider {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            -webkit-appearance: none;
        }
        .sensitivity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>å¤ç´è°ƒéŸ³å™¨</h1>
    <div class="mode" id="mode">æ­£è°ƒ (A4=440Hz)</div>

    <button id="micBtn" class="mic-btn">ğŸ¤ ç‚¹å‡»å¼€å¯éº¦å…‹é£</button>

    <div class="meter">
        <div class="circle"></div>
        <div class="progress" id="progress"></div>
        <div class="center">
            <div class="note" id="note">ç¬¬1å¼¦</div>
            <div class="hz" id="hz">--- Hz</div>
            <div class="status" id="status">æœªå¼€å¯éº¦å…‹é£</div>
        </div>
    </div>

    <div class="strings" id="strings"></div>

    <div class="sensitivity">
        <div class="sensitivity-label">çµæ•åº¦ï¼ˆè¶Šä½è¶Šçµæ•ï¼‰</div>
        <input type="range" id="sensi" min="0.01" max="0.1" step="0.01" value="0.03">
    </div>

    <div class="bar">
        <button class="tuning active" data-mode="zheng">æ­£è°ƒ</button>
        <button class="tuning" data-mode="jin5">ç´§äº”</button>
        <button class="tuning" data-mode="man3">æ…¢ä¸‰</button>
        <button id="reset">ğŸ”„ å¤ä½</button>
    </div>

    <div class="bar">
        <button class="tone active" data-tone="440">440Hz</button>
        <button class="tone" data-tone="432">432Hz</button>
    </div>
</div>

<script>
    const base440 = {
        zheng: [65.41,73.42,87.31,98.00,110.00,130.81,146.83],
        jin5: [65.41,73.42,87.31,98.00,116.54,130.81,146.83],
        man3: [65.41,73.42,82.41,98.00,110.00,130.81,146.83]
    };

    let currentTuning = 'zheng';
    let currentString = 0;
    let baseTone = 440;
    let target = JSON.parse(JSON.stringify(base440));
    let sensitivity = 0.03;
    let audioContext, analyser;
    let micOn = false;

    const micBtn = document.getElementById('micBtn');
    const stringsEl = document.getElementById('strings');
    const progress = document.getElementById('progress');
    const note = document.getElementById('note');
    const hz = document.getElementById('hz');
    const status = document.getElementById('status');
    const modeText = document.getElementById('mode');
    const sensiSlider = document.getElementById('sensi');
    const resetBtn = document.getElementById('reset');

    // å¼¦æŒ‰é’®
    for (let i=0; i<7; i++) {
        let b = document.createElement('button');
        b.className = 'string-btn';
        b.textContent = i+1;
        b.onclick = () => { currentString = i; updateString(); };
        stringsEl.appendChild(b);
    }

    // è°ƒå¼
    document.querySelectorAll('.tuning').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tuning').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentTuning = btn.dataset.mode;
            updateMode();
        };
    });

    // åŸºå‡†éŸ³
    document.querySelectorAll('.tone').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tone').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            baseTone = Number(btn.dataset.tone);
            let r = baseTone/440;
            for(let m in target) target[m] = base440[m].map(f=>f*r);
            updateMode();
        };
    });

    // çµæ•åº¦
    sensiSlider.oninput = () => {
        sensitivity = Number(sensiSlider.value);
    };

    // å¤ä½
    resetBtn.onclick = () => {
        currentTuning = 'zheng';
        currentString = 0;
        baseTone = 440;
        sensitivity = 0.03;
        sensiSlider.value = 0.03;
        document.querySelectorAll('.tuning')[0].classList.add('active');
        document.querySelectorAll('.tone')[0].classList.add('active');
        updateMode();
        updateString();
    };

    // éº¦å…‹é£ï¼ˆè‹¹æœå¿…ç”¨ï¼‰
    micBtn.onclick = async () => {
        if(micOn) return;
        try {
            micBtn.disabled = true;
            micBtn.textContent = "ğŸ¤ éº¦å…‹é£å·²å¼€å¯";
            let stream = await navigator.mediaDevices.getUserMedia({audio:true});
            audioContext = new AudioContext();
            let mic = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 4096;
            mic.connect(analyser);
            micOn = true;
            status.textContent = "ç­‰å¾…å‘å£°...";
            loop();
        } catch(e) {
            micBtn.disabled = false;
            micBtn.textContent = "âŒ è¯·å…è®¸éº¦å…‹é£";
        }
    };

    function updateMode() {
        const names = {zheng:'æ­£è°ƒ', jin5:'ç´§äº”å¼¦', man3:'æ…¢ä¸‰å¼¦'};
        modeText.textContent = `${names[currentTuning]} (A4=${baseTone}Hz)`;
        updateString();
    }

    function updateString() {
        document.querySelectorAll('.string-btn').forEach((b,i) => {
            b.classList.toggle('active', i===currentString);
        });
        note.textContent = `ç¬¬${currentString+1}å¼¦`;
    }

    function loop() {
        requestAnimationFrame(loop);
        if(!micOn || !analyser) return;

        let buf = new Float32Array(analyser.fftSize);
        analyser.getFloatTimeDomainData(buf);

        let vol = Math.sqrt(buf.reduce((s,v)=>s+v*v,0)/buf.length);
        if(vol < sensitivity) {
            hz.textContent = '--- Hz';
            status.textContent = 'ç­‰å¾…å‘å£°...';
            progress.style.transform = 'rotate(-90deg)';
            return;
        }

        let freq = getPitch(buf, audioContext.sampleRate);
        if(freq<50||freq>400) return;

        hz.textContent = freq.toFixed(1)+' Hz';
        let aim = target[currentTuning][currentString];
        let cents = 1200 * Math.log2(freq/aim);
        showMeter(cents);
    }

    function showMeter(cents) {
        let color='#4CAF50', text='å·²å‡† âœ“', angle=0;
        if(cents>10){ color='#F44336'; text='åé«˜'; angle=Math.min(cents/50,1)*360; }
        else if(cents<-10){ color='#2196F3'; text='åä½'; angle=Math.max(cents/50,-1)*360; }
        progress.style.borderTopColor = color;
        progress.style.transform = `rotate(${-90+angle}deg)`;
        status.textContent = text;
    }

    function getPitch(buf,sr){
        let maxCor=0,bestT=0;
        let min=Math.floor(sr/400),max=Math.floor(sr/50);
        for(let t=min;t<max;t++){
            let c=0;
            for(let i=0;i<buf.length-t;i++) c+=buf[i]*buf[i+t];
            if(c>maxCor){maxCor=c;bestT=t;}
        }
        return bestT?sr/bestT:0;
    }

    updateMode();
    updateString();
</script>
</body>

</html>
